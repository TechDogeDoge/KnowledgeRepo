# 操作系统

[TOC]

## 计算机硬件结构

### 内存

内存是用来存储数据和代码的。通常用内存地址来表示数据或代码存储的位置，格式为`0x068B`，采用十六进制

### CPU

CPU是Central Processing Unit的简称，负责执行用户和OS下发的指令。CPU内部主要由寄存器、算术逻辑单元（ALU）、控制单元（CU）组成。

### 总线 Bus

总线是计算机CPU和其他硬件之间用来传送信息和数据的通信干线，是由导线组成的传输线束。按照总线中传递信息的类型可以分为三类：地址总线、数据总线、控制总线。

#### 地址总线

地址总线用来传递内存地址的信息，地址总线的根数决定了寻址的能力。每根总线，只可以代表一个比特的数据，于是如果一个计算机有32根地址总线，则内存地址最大为$2^{32} bit = 4 GB$。而当下最常用的计算机有64根地址总线，也就是内存地址最大为$2^{64} bit$

#### 数据总线

数据总线用来传递数据，包括传递读写内存的数据，CPU和I/O硬件之间的数据

#### 控制总线

控制总线用来传递控制信号和时序信号。控制信号包括CPU传递给内存和I/O硬件的读写信号、中断响应信号等，以及内存和I/O硬件传递给CPU的中断申请信号、复位信号、设备就绪信号灯

### 寄存器 Register

寄存器是CPU内部十分重要的部件，一般包括：通用寄存器、程序计数器、指令寄存器

- 通用寄存器：用来存储进行运算的数据
- 程序计数器：用来存储下一条指令的**内存地址**
- 指令寄存器：用来存放程序计数器中指向的指令

### 存储器

计算机内部的存储器具有层次结构，按照速度从快到慢可以划分为：寄存器、缓存Cache、内存、硬盘

寄存器仅能存储8个字节的数据(64位计算机)，但速度最快，同时也数目最少。

缓存同样存在于CPU中，也还具体细分为L1 Cache、L2 Cache、L3 Cache。缓存采用SRAM（Static-RAM），名字中的`Static`代表，缓存中的数据尽在有电时保存，一旦断电则全部丢失。

内存在CPU外，采用DRAM（Dynamic-RAM），名字中的`Dynamic`代表，内存中的数据都存在电容里面，且电容不断漏电，所以需要定时刷新电容，才能保证数据不会丢失。

由于存储器之间速度的差异，当CPU需要访问内存中的某个数据时，会按照寄存器->L1 Cache->L2 Cache->L3 Cache->内存的顺序进行查询，中间任意一次查询到即可以返回。

硬盘分为HDD和SSD，且断电后数据也不会丢失。

## 操作系统结构

### 指令

CPU大多使用流水线的方式来执行指令，将一个指令分为四个阶段：

1. 取指令(Fetch)：从内存中获取指令到控制器中
2. 解码指令(Decode)：将指令解析成不同的操作信号、地址和操作数
3. 执行指令(Execution)：
4. 回写(Store)：将指令执行结果写回内存

上面这四个阶段，也称为指令周期。

> 指令周期和时钟周期
>
> 时钟周期是CPU完成一个最基本动作的时间周期，CPU有一个参数叫做主频，比如5.0GHz，这个5.0GHz就代表一个时钟周期是`1/5.0G`秒
>
> 指令周期一般等于一个或多个时钟周期

### 程序执行

CPU执行程序的基本流程：

1. CPU读取**程序计数器**，即获取指令的内存地址；
2. 通过**地址总线**将指令内存地址传递给内存；
3. 内存通过数据总线将指令传递给CPU；
4. CPU收到指令后，将指令存入**指令寄存器**；
5. CPU分析指令的类型和参数。将指令交给ALU，或CU；
6. ALU或CU执行完指令后，程序计数器的值自增，指向下一条指令，对于64位的计算机，需要8个字节存储地址，程序计数器自增8；

下面以运算`a = 1 + 2`为例说明执行的过程：

首先编译过程中，会在内存中开辟空间存储数据`1`和`2`。

然后编译器会将`a = 1 + 2`这条运算翻译为4条指令，并在内存中开辟空间进行存储。

最后执行的时候会按照地址，一条一条的执行指令。如下图所示，首先执行0x200处存放的指令。

<img src="C:\Users\jiaoy\AppData\Roaming\Typora\typora-user-images\image-20220118215405523.png" alt="image-20220118215405523" style="zoom: 40%;" />

### 中断

中断是操作系统响应硬件设备请求的一种机制。操作系统收到硬件的中断请求，会打断当前运行的进程，转而处理硬件的请求。而响应中断时，还有可能会临时关闭中断，这意味着如果执行中断请求过长，会导致无法处理后面的中断请求。

由于上面的原因，中断的响应程序会分为两个部分：

上半部：直接处理硬件请求，也就是硬中断，耗时短，快速执行；

上半部：内核触发一个内核线程，也就是软中断，耗时长；

硬中断会打断CPU正在执行的程序，但是软中断由于是采用线程执行，不会打断当前执行的程序。

> 软中断
>
> 硬件的中断下半部是软终端的一种，一些内核自定义时间也是软终端，比如内核调度，RCU锁等

### 内核

内核是操作系统内部的最基本的部分，是硬件和应用程序之间的桥梁

内核的功能：

1. 管理和调度进程线程；
2. 管理内存，分配和回收内存；
3. 管理硬件，为进程和硬件之间提供通信能力
4. 提供系统调用：向应用程序提供调用操作系统功能的接口

#### 内核空间和用户空间

按照权限，操作系统将内存分为内核空间和用户空间。内核空间只能由内核访问。内核空间中存储的是内核代码和数据，而用户空间中存储的是应用程序的代码和数据。

当一个任务（进程）执行系统调用（比如文件操作或者网络数据发送）而执行内核代码时，称进程处于内核运行态（内核态）。当进程处于内核态时，执行的内核代码会使用当前进程的内核栈。每个进程都有自己的内核栈。

内核空间和用户空间转换：

1. 系统调用
2. 异常：应用程序执行遇到异常时，会由内核对异常进行处理
3. 中断：收到硬件的中断请求，切换到内核态进行处理

![image-20220124221233474](C:\Users\jiaoy\AppData\Roaming\Typora\typora-user-images\image-20220124221233474.png)

## 内存管理

### 物理内存

### 虚拟内存

## 进程线程管理

## 调度算法

## 文件系统

## 设备管理

## 网络系统



